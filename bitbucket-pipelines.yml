image: node:12
pipelines:
    default:
        - step:
            script:
                # install dependencies
                - apt-get update
                - apt-get --yes install zip
                - apt-get --yes install curl
                - apt-get --yes install gconf-service libasound2 libatk1.0-0 libc6 libcairo2 libcups2 libdbus-1-3 libexpat1 libfontconfig1 libgcc1 libgconf-2-4 libgdk-pixbuf2.0-0 libglib2.0-0 libgtk-3-0 libnspr4 libpango-1.0-0 libpangocairo-1.0-0 libstdc++6 libx11-6 libx11-xcb1 libxcb1 libxcomposite1 libxcursor1 libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxss1 libxtst6 ca-certificates fonts-liberation libappindicator1 libnss3 lsb-release xdg-utils wget   # chrome headless dependencies
                - npm install -g json
                - npm install

                # run some checks
                - npm run test
                - npm run formatting:check

                # build the project
                - npm run build
                - npm run documentation

                # get the current name/version of the project
                - NAME=$(json -f ./package.json name)
                - VERSION=$(json -f ./package.json version)

                # zip the output
                - pushd "./build/"
                - zip -r "../${NAME}_${VERSION}.zip" *
                - popd

                # zip the documentation
                - pushd "./documentation/"
                - zip -r "../${NAME}_${VERSION}_documentation.zip" *
                - popd

                # upload to the 'downloads' section of the bitbucket project
                - curl -X POST "https://${BB_AUTH_STRING}@api.bitbucket.org/2.0/repositories/drk4/javascript_utilities/downloads" --form files=@"${NAME}_${VERSION}.zip"
                - curl -X POST "https://${BB_AUTH_STRING}@api.bitbucket.org/2.0/repositories/drk4/javascript_utilities/downloads" --form files=@"${NAME}_${VERSION}_documentation.zip"
